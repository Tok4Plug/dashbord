<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>Dashboard - TOK4 PLUG</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root{
      --bg:#0b0312; --panel:#181028; --card:#221533;
      --accent:#7b2cff; --accent-2:#9b55ff; --muted:#9aa0a6;
      --ok:#22c55e; --warn:#ffb020; --danger:#ff4d6d; --info:#38bdf8;
      --chip-bg:#140c22; --chip-bd:#2a1a3a; --toast-bg:#2a1a3a;
      font-family: Inter, system-ui, -apple-system,"Segoe UI", Roboto, Arial;
    }
    *{box-sizing:border-box}
    body{margin:0; background:var(--bg); color:#fff; padding:20px}
    .container{max-width:1600px; margin:0 auto}

    /* Header */
    header{display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:18px; flex-wrap:wrap}
    h1{margin:0; font-size:28px; font-weight:900; color:var(--accent); letter-spacing:-.5px}
    .top-actions{display:flex; gap:10px; flex-wrap:wrap}
    button{border:0; padding:9px 14px; border-radius:8px; cursor:pointer; transition:.2s; font-weight:600; font-size:14px}
    button.primary{background:linear-gradient(90deg,var(--accent),var(--accent-2)); color:#fff; box-shadow:0 3px 12px rgba(123,44,255,.3)}
    button.primary:hover{transform:scale(1.05)}
    button.ghost{background:transparent; border:1px solid rgba(255,255,255,.1); color:#fff}
    button.ghost:hover{border-color:var(--accent-2)}
    .input{background:var(--card); border:1px solid rgba(255,255,255,.15); color:#fff; padding:10px 12px; border-radius:8px; font-size:14px; outline:none}

    /* Stats */
    .stats{display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:12px; margin:16px 0}
    .stat{background:var(--card); border:1px solid rgba(255,255,255,.06); padding:16px; border-radius:12px; transition:.3s; text-align:center; animation:fadeIn .6s ease}
    .stat:hover{transform:translateY(-3px) scale(1.02); box-shadow:0 6px 18px rgba(0,0,0,.4)}
    .stat .label{color:var(--muted); font-size:12px}
    .stat .value{font-size:22px; font-weight:800; margin-top:6px}
    .stat.warn .value{color:var(--warn)}
    .stat.danger .value{color:var(--danger)}
    .stat.ok .value{color:var(--ok)}

    /* Painel */
    .panel{background:var(--panel); border:1px solid rgba(255,255,255,.06); padding:18px; border-radius:14px; box-shadow:0 6px 24px rgba(0,0,0,.35); animation:slideIn .7s ease}
    table{width:100%; border-collapse:collapse; color:#fff; font-size:14px}
    th, td{padding:10px 8px; border-bottom:1px solid rgba(255,255,255,.06); vertical-align:middle}
    th{font-size:12px; color:var(--muted); text-transform:uppercase; letter-spacing:.5px; background:var(--panel); position:sticky; top:0; z-index:1}
    tr:hover td{background:rgba(255,255,255,.03)}

    /* Estados */
    .pill{padding:6px 10px; border-radius:999px; font-size:12px; font-weight:700; border:1px solid; display:inline-block}
    .pill.activo{color:var(--ok); background:rgba(34,197,94,.12); border-color:rgba(34,197,94,.25)}
    .pill.reserva{color:var(--accent-2); background:rgba(155,85,255,.12); border-color:rgba(155,85,255,.25)}

    /* Chips */
    .chip{display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; border:1px solid var(--chip-bd); background:var(--chip-bg); font-size:12px; margin:2px 0}
    .chip.ok{color:var(--ok); border-color:rgba(34,197,94,.25); background:rgba(34,197,94,.08)}
    .chip.fail{color:var(--danger); border-color:rgba(255,77,109,.25); background:rgba(255,77,109,.08)}
    .chip.warn{color:var(--warn); border-color:rgba(255,176,32,.25); background:rgba(255,176,32,.08)}
    .chip.info{color:var(--info); border-color:rgba(56,189,248,.25); background:rgba(56,189,248,.08)}

    /* Logs */
    .logs{margin-top:14px; background:#12081d; border:1px solid rgba(255,255,255,.06); padding:12px; border-radius:10px; max-height:280px; overflow:auto; font-size:12.5px; color:#cfcfe5; line-height:1.45}
    .logs div.warn{color:var(--warn)} .logs div.ok{color:var(--ok)} .logs div.error{color:var(--danger)}

    /* Drawer */
    .drawer{position:fixed; top:0; right:-500px; width:420px; height:100%; background:var(--panel); box-shadow:-4px 0 18px rgba(0,0,0,.6); transition:.3s; z-index:3000; padding:20px; overflow-y:auto}
    .drawer.open{right:0}
    .drawer h2{margin-top:0; font-size:20px; color:var(--accent-2)}
    .drawer pre{background:#0f0718; border:1px solid rgba(255,255,255,.08); padding:12px; border-radius:8px; font-size:12px; color:#eee; overflow-x:auto}

    /* Toasts */
    .toast{position:fixed; bottom:20px; right:20px; background:var(--toast-bg); color:#fff; padding:12px 18px; border-radius:8px; opacity:0; transform:translateY(20px); transition:.25s; z-index:4000; box-shadow:0 2px 12px rgba(0,0,0,.5)}
    .toast.show{opacity:1; transform:translateY(0)}

    /* Animations */
    @keyframes fadeIn{from{opacity:0; transform:translateY(10px)}to{opacity:1; transform:translateY(0)}}
    @keyframes slideIn{from{opacity:0; transform:translateY(20px)}to{opacity:1; transform:translateY(0)}}

    /* Responsivo */
    @media(max-width:900px){
      table, thead, tbody, th, td, tr{display:block}
      th{display:none}
      td{border:none; padding:8px 0}
      tr{border-bottom:1px solid rgba(255,255,255,.08); margin-bottom:14px}
    }
  </style>
</head>
<body>
<div class="container">
  <header>
    <h1>TOK4 <span style="color:var(--accent-2)">PLUG</span></h1>
    <div class="top-actions row">
      <input id="search" class="input" placeholder="Pesquisar…" style="min-width:200px">
      <select id="filter-health" class="input">
        <option value="">Saúde: todos</option><option value="ok">OK</option><option value="fail">Falha</option>
      </select>
      <select id="filter-status" class="input">
        <option value="">Status: todos</option><option value="ativo">Ativo</option><option value="reserva">Reserva</option>
      </select>
      <button class="ghost" id="btn-refresh">🔄 Atualizar</button>
    </div>
  </header>

  <!-- Estatísticas -->
  <div id="stats" class="stats">
    <div class="stat"><div class="label">Ativos</div><div id="count-ativos" class="value">0</div></div>
    <div class="stat"><div class="label">Reservas</div><div id="count-reserva" class="value">0</div></div>
    <div class="stat"><div class="label">Checagens</div><div id="checks-total" class="value">0</div></div>
    <div class="stat danger"><div class="label">Falhas</div><div id="failures-total" class="value">0</div></div>
    <div class="stat ok"><div class="label">Trocas</div><div id="switches-total" class="value">0</div></div>
    <div class="stat"><div class="label">Última verificação</div><div id="last-action" class="value">—</div></div>
  </div>

  <!-- Painel -->
  <div class="panel">
    <div class="toolbar">
      <div class="row">
        <span id="monitor-lock-badge" class="badge">lock…</span>
        <span id="policy-badge" class="badge amber">policy …</span>
      </div>
      <div class="row tiny muted">Clique no nome do bot para ver detalhes completos →</div>
    </div>

    <table>
      <thead>
        <tr>
          <th>ID</th><th>Nome</th><th>Status</th><th>Saúde</th>
          <th>Token</th><th>Webhook</th><th>URL</th><th>Probe</th>
          <th>Checks</th><th>Último OK</th><th>Ações</th>
        </tr>
      </thead>
      <tbody id="bots-tbody"></tbody>
    </table>

    <div class="logs" id="logs"></div>
  </div>
</div>

<!-- Drawer lateral -->
<div class="drawer" id="drawer">
  <h2 id="drawer-title">Detalhes do Bot</h2>
  <div id="drawer-content"></div>
</div>

<div id="toasts"></div>

<script>
  const qs = s=>document.querySelector(s);
  const esc = s=>s?s.replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])):"";
  const formatDt = s=>s?new Date(s).toLocaleString():"—";
  const toast = msg=>{const el=document.createElement('div');el.className='toast';el.textContent=msg;
    document.body.appendChild(el);requestAnimationFrame(()=>el.classList.add('show'));
    setTimeout(()=>{el.classList.remove('show');setTimeout(()=>el.remove(),200)},3500)};
  let DATA={bots:[],logs:[],metrics:{},last_action:null},FILTER={text:"",status:"",health:""};

  async function fetchData(){
    const r=await fetch('/api/bots',{cache:'no-store'});if(!r.ok){toast('Erro na API');return}
    DATA=await r.json();renderAll();
  }
  function renderAll(){
    const m=DATA.metrics||{};
    qs('#checks-total').textContent=m.checks_total??0;
    qs('#failures-total').textContent=m.failures_total??0;
    qs('#switches-total').textContent=m.switches_total??0;
    if(DATA.last_action)qs('#last-action').textContent=new Date(DATA.last_action*1000).toLocaleString();
    let a=0,r=0;(DATA.bots||[]).forEach(b=>b.status==='ativo'?a++:r++);qs('#count-ativos').textContent=a;qs('#count-reserva').textContent=r;
    const hasLock=m.monitor_has_lock;qs('#monitor-lock-badge').textContent=hasLock?'monitor: lock OK':'monitor: sem lock';qs('#monitor-lock-badge').className='badge '+(hasLock?'green':'red');
    let policy='';for(const b of(DATA.bots||[])){if(b._diag&&b._diag.policy_reason){policy=b._diag.policy_reason;break}}qs('#policy-badge').textContent=policy||'policy indisponível';
    renderTable();renderLogs(DATA.logs||[]);
  }
  function matchFilter(b){const t=(FILTER.text||'').toLowerCase().trim();if(t&&!(`${b.name||''} ${b.redirect_url||''}`.toLowerCase().includes(t)))return false;
    if(FILTER.status&&b.status!==FILTER.status)return false;
    const ok=(b._diag&&typeof b._diag.decision_ok==='boolean')?b._diag.decision_ok:((b.failures||0)===0);
    if(FILTER.health==='ok'&&!ok)return false;if(FILTER.health==='fail'&&ok)return false;return true}
  function renderTable(){const tbody=qs('#bots-tbody');tbody.innerHTML='';(DATA.bots||[]).filter(matchFilter).forEach(b=>{
    const d=b._diag||{},ok=(typeof d.decision_ok==='boolean')?d.decision_ok:((b.failures||0)===0);
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${b.id}</td><td><a href="#" onclick="openDrawer(${b.id});return false;">${esc(b.name||'')}</a></td>
    <td><span class="pill ${b.status==='ativo'?'activo':'reserva'}">${b.status}</span></td>
    <td>${ok?'<span class="ok">✅</span>':'<span class="fail">❌</span>'}</td>
    <td>${d.token_ok===false?'<span class="chip fail">token</span>':'<span class="chip ok">token</span>'}</td>
    <td>${d.webhook_ok===false?'<span class="chip fail">webhook</span>':'<span class="chip ok">webhook</span>'}</td>
    <td>${d.url_ok===false?'<span class="chip fail">url</span>':'<span class="chip ok">url</span>'}</td>
    <td>${d.probe_ok===false?'<span class="chip fail">probe</span>':'<span class="chip ok">probe</span>'}</td>
    <td class="mono">${b.failures||0}</td><td class="tiny">${formatDt(b.last_ok)}</td>
    <td><button class="ghost tiny" onclick="forceSwap(${b.id})">🔁</button> <button class="ghost tiny" onclick="del(${b.id})">🗑</button></td>`;
    tbody.appendChild(tr)});}
  function renderLogs(logs){const box=qs('#logs');box.innerHTML='';logs.forEach(l=>{let cls='';if(l.includes('⚠️'))cls='warn';if(l.includes('✅'))cls='ok';if(l.includes('❌')||l.includes('⛔'))cls='error';
    const div=document.createElement('div');div.className=cls;div.textContent=l;box.appendChild(div)});box.scrollTop=box.scrollHeight}
  function openDrawer(id){const b=(DATA.bots||[]).find(x=>x.id===id);if(!b)return;qs('#drawer').classList.add('open');qs('#drawer-title').textContent=`${b.name} (#${b.id})`;
    const d=b._diag||{};qs('#drawer-content').innerHTML=`<p>Status: <b>${b.status}</b></p><p>Redirect: ${esc(b.redirect_url||'')}</p>
    <p>Último OK: ${formatDt(b.last_ok)}</p><h3>Diagnóstico Completo</h3><pre>${esc(JSON.stringify(d,null,2))}</pre>`}
  document.addEventListener('keydown',e=>{if(e.key==='Escape')qs('#drawer').classList.remove('open')});
  async function forceSwap(id){await fetch(`/api/bots/${id}/force_swap`,{method:'POST'});toast('🔁 Swap solicitado');fetchData()}
  async function del(id){if(!confirm('Excluir bot?'))return;await fetch(`/api/bots/${id}`,{method:'DELETE'});toast('✅ Excluído');fetchData()}
  qs('#btn-refresh').addEventListener('click',fetchData);
  qs('#search').addEventListener('input',e=>{FILTER.text=e.target.value;renderTable()});
  qs('#filter-status').addEventListener('change',e=>{FILTER.status=e.target.value;renderTable()});
  qs('#filter-health').addEventListener('change',e=>{FILTER.health=e.target.value;renderTable()});
  fetchData();setInterval(fetchData,15000);
</script>
</body>
</html>