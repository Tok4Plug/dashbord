<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>Dashboard - TOK4 PLUG</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root {
      --bg:#0b0312; --panel:#181028; --accent:#7b2cff; --accent-2:#9b55ff;
      --muted:#9aa0a6; --card:#221533; --ok:#22c55e; --warn:#ffb020; --danger:#ff4d6d;
      --toast-bg:#2a1a3a; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    }
    body { background:var(--bg); color:#fff; margin:0; padding:20px; }
    .container { max-width:1400px; margin:0 auto; }
    header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
    h1 { font-weight:800; color:var(--accent); margin:0; font-size:30px; letter-spacing:-0.5px; }
    .top-actions { display:flex; gap:12px; }
    button { border:0; padding:9px 16px; border-radius:8px; cursor:pointer; transition:all .2s; font-weight:600; font-size:14px; }
    button.primary { background:linear-gradient(90deg,var(--accent),var(--accent-2)); color:#fff; box-shadow:0 3px 12px rgba(123,44,255,0.3); }
    button.primary:hover { transform:scale(1.06); }
    button.ghost { background:transparent; border:1px solid rgba(255,255,255,0.08); color:var(--muted); }
    button.ghost:hover { border-color:var(--accent-2); color:#fff; }
    .stats { display:flex; gap:14px; margin-bottom:20px; flex-wrap:wrap; }
    .stat { background:var(--card); padding:18px; border-radius:12px; flex:1; min-width:180px; display:flex; flex-direction:column; align-items:flex-start; }
    .stat .label { font-size:13px; color:var(--muted); }
    .stat .value { font-size:24px; font-weight:700; margin-top:6px; }
    .panel { background:var(--panel); padding:20px; border-radius:14px; box-shadow:0 4px 20px rgba(0,0,0,0.4); }
    table { width:100%; border-collapse:collapse; margin-top:12px; color:#fff; font-size:14px; }
    th,td { padding:12px; text-align:left; border-bottom:1px solid rgba(255,255,255,0.05); }
    th { color:var(--muted); font-size:12px; text-transform:uppercase; letter-spacing:0.5px; }
    .pill { padding:6px 12px; border-radius:999px; font-size:12px; font-weight:600; }
    .activo { background:rgba(34,197,94,0.12); color:var(--ok); border:1px solid rgba(34,197,94,0.18); }
    .reserva { background:rgba(155,85,255,0.12); color:var(--accent-2); border:1px solid rgba(155,85,255,0.18); }
    .ok { color:var(--ok); font-weight:600; }
    .fail { color:var(--danger); font-weight:600; }
    .logs { margin-top:18px; background:#12081d; padding:14px; border-radius:10px; max-height:280px; overflow-y:auto; font-size:13px; color:#cfcfe5; line-height:1.5; }
    .logs div.warn { color:var(--warn); }
    .logs div.ok { color:var(--ok); }
    .logs div.error { color:var(--danger); }
    input,select { background:var(--card); border:1px solid rgba(255,255,255,0.15); color:#fff; padding:10px; border-radius:6px; width:100%; font-size:14px; }
    select { cursor:pointer; }
    .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); align-items:center; justify-content:center; z-index:1000; }
    .modal-content { background:var(--panel); padding:22px; border-radius:14px; width:420px; box-shadow:0 6px 30px rgba(0,0,0,.6); }
    .modal h3 { margin:0 0 14px; font-size:18px; font-weight:700; }
    .modal .actions { display:flex; justify-content:flex-end; gap:10px; margin-top:16px; }

    /* Toasts */
    .toast { position:fixed; bottom:20px; right:20px; background:var(--toast-bg); color:#fff; padding:12px 18px; border-radius:8px; margin-top:10px; opacity:0; transform:translateY(20px); transition:all .3s; z-index:2000; box-shadow:0 2px 12px rgba(0,0,0,0.5); }
    .toast.show { opacity:1; transform:translateY(0); }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>TOK4 <span style="color:var(--accent-2)">PLUG</span></h1>
      <div class="top-actions">
        <button class="primary" id="btn-open-add">‚ûï Adicionar Bot</button>
        <button class="ghost" id="btn-refresh">üîÑ Atualizar</button>
      </div>
    </header>

    <div class="stats">
      <div class="stat"><div class="label">Ativos</div><div id="count-ativos" class="value">0</div></div>
      <div class="stat"><div class="label">Reserva</div><div id="count-reserva" class="value">0</div></div>
      <div class="stat"><div class="label">√öltima a√ß√£o</div><div id="last-action" class="value">‚Äî</div></div>
      <div class="stat"><div class="label">Checagens</div><div id="checks-total" class="value">0</div></div>
      <div class="stat"><div class="label">Falhas</div><div id="failures-total" class="value">0</div></div>
      <div class="stat"><div class="label">Trocas</div><div id="switches-total" class="value">0</div></div>
    </div>

    <div class="panel">
      <table>
        <thead>
          <tr>
            <th>ID</th><th>Nome</th><th>Status</th><th>Sa√∫de Detectada</th>
            <th>Falhas</th><th>√öltimo OK</th><th>√öltima Raz√£o</th><th>Redirect</th><th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="bots-tbody"></tbody>
      </table>
      <div class="logs" id="logs"></div>
    </div>

    <!-- Modal -->
    <div class="modal" id="modal">
      <div class="modal-content">
        <h3 id="modal-title">Adicionar Bot</h3>
        <div style="display:flex;flex-direction:column; gap:12px;">
          <input id="f-name" type="text" placeholder="Nome do Bot">
          <input id="f-token" type="text" placeholder="Token do Bot (opcional)">
          <input id="f-redirect" type="url" placeholder="Redirect URL (https://...)">
          <select id="f-status">
            <option value="ativo">Ativo</option>
            <option value="reserva">Reserva</option>
          </select>
          <div class="actions">
            <button class="ghost" onclick="closeModal()">Cancelar</button>
            <button class="primary" onclick="saveBot()">Salvar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast container -->
    <div id="toasts"></div>
  </div>

<script>
  function qs(sel){return document.querySelector(sel)}
  function showToast(msg){
    const el=document.createElement("div");
    el.className="toast"; el.innerText=msg;
    document.getElementById("toasts").appendChild(el);
    setTimeout(()=>el.classList.add("show"),50);
    setTimeout(()=>{el.classList.remove("show"); setTimeout(()=>el.remove(),300)},4000);
  }

  async function refreshData(){
    const res = await fetch("/api/bots");
    const data = await res.json();
    renderTable(data.bots);
    renderLogs(data.logs||[]);
    if(data.last_action) qs("#last-action").innerText=new Date(data.last_action*1000).toLocaleString();
    qs("#checks-total").innerText=data.metrics.checks_total||0;
    qs("#failures-total").innerText=data.metrics.failures_total||0;
    qs("#switches-total").innerText=data.metrics.switches_total||0;
  }

  function renderTable(bots){
    const tbody=qs("#bots-tbody"); tbody.innerHTML="";
    let ativos=0,reserva=0;
    bots.forEach(b=>{
      if(b.status==="ativo") ativos++; else reserva++;
      const tr=document.createElement("tr");
      const health = b.failures>0 ? `<span class="fail">‚ùå Falha</span>` : `<span class="ok">‚úÖ OK</span>`;
      tr.innerHTML=`
        <td>${b.id}</td>
        <td>${escapeHtml(b.name)}</td>
        <td><span class="pill ${b.status==="ativo"?"activo":"reserva"}">${b.status}</span></td>
        <td>${health}</td>
        <td class="${b.failures>0?'fail':''}">${b.failures||0}</td>
        <td>${b.last_ok ? new Date(b.last_ok).toLocaleString() : "‚Äî"}</td>
        <td>${escapeHtml(b.last_reason||"‚Äî")}</td>
        <td><a href="${escapeAttr(b.redirect_url)}" target="_blank">${escapeHtml(b.redirect_url)}</a></td>
        <td>
          <button class="ghost" onclick="openEdit(${b.id})">‚úèÔ∏è</button>
          <button class="ghost" onclick="forceSwap(${b.id})">üîÅ</button>
          <button class="ghost" onclick="deleteBot(${b.id})">üóëÔ∏è</button>
        </td>`;
      tbody.appendChild(tr);
    });
    qs("#count-ativos").innerText=ativos;
    qs("#count-reserva").innerText=reserva;
  }

  function renderLogs(logs){
    const box=qs("#logs"); box.innerHTML="";
    logs.forEach(l=>{
      let cls=""; if(l.includes("‚ö†Ô∏è")) cls="warn"; if(l.includes("‚úÖ")) cls="ok"; if(l.includes("‚ùå")) cls="error";
      const div=document.createElement("div"); div.className=cls; div.innerText=l; box.appendChild(div);
    });
    box.scrollTop=box.scrollHeight;
  }

  function escapeHtml(s){return s? s.replace(/[&<>]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c])):""}
  function escapeAttr(s){return s? s.replace(/"/g,"&quot;"):""}

  // Modal
  let editingId=null;
  function openAdd(){editingId=null;resetForm();qs("#modal-title").innerText="Adicionar Bot";qs("#modal").style.display="flex";}
  function openEdit(id){
    editingId=id;
    fetch('/api/bots').then(r=>r.json()).then(d=>{
      const bot=d.bots.find(x=>x.id===id); if(!bot) return;
      qs("#modal-title").innerText="Editar Bot";
      qs("#f-name").value=bot.name; qs("#f-token").value=bot.token||""; qs("#f-redirect").value=bot.redirect_url; qs("#f-status").value=bot.status;
      qs("#modal").style.display="flex";
    });
  }
  function closeModal(){qs("#modal").style.display="none"; editingId=null;}
  function resetForm(){qs("#f-name").value="";qs("#f-token").value="";qs("#f-redirect").value="";qs("#f-status").value="reserva";}

  async function saveBot(){
    const body={name:qs("#f-name").value.trim(),token:qs("#f-token").value.trim(),redirect_url:qs("#f-redirect").value.trim(),status:qs("#f-status").value};
    if(!body.name||!body.redirect_url) return showToast("‚ö†Ô∏è Nome e Redirect s√£o obrigat√≥rios");
    const method=editingId?"PUT":"POST";
    const url=editingId?`/api/bots/${editingId}`:"/api/bots";
    const res=await fetch(url,{method,headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});
    if(res.ok){ showToast("‚úÖ Bot salvo com sucesso"); closeModal(); refreshData(); }
    else { const err=await res.json(); showToast("‚ùå Erro: "+(err.error||"falha")); }
  }
  async function deleteBot(id){
    if(!confirm("Excluir este bot?")) return;
    const res=await fetch(`/api/bots/${id}`,{method:"DELETE"});
    if(res.ok){ showToast("‚úÖ Bot exclu√≠do"); refreshData(); }
    else showToast("‚ùå Erro ao excluir");
  }
  async function forceSwap(id){
    if(!confirm("For√ßar troca deste bot?")) return;
    await fetch(`/api/bots/${id}/force_swap`,{method:"POST"});
    showToast("üîÅ Swap for√ßado"); refreshData();
  }

  qs("#btn-open-add").addEventListener("click",openAdd);
  qs("#btn-refresh").addEventListener("click",refreshData);

  refreshData(); setInterval(refreshData,15000);
</script>
</body>
</html>